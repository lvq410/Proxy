# 基本用法
内网穿透适用于更复杂的网络场景，一般为从公网突破进入内网，具体场景例：

有请求者`A`，目标服务`B`在`3306`端口上对外提供服务，一般`A`在公网（或者其它局域网），`B`在另一个局域网

但是并不存在一个机器`C`，使得`A`与`C`互通，`C`与`B`互通

但是存在这样一个机器`D`，一般这个`D`就在公网

`A`可以访问到`D`，但`D`不一定能直接访问到`A`，如`A`在局域网时

`B`，或者与`B`在同一个局域网的`E`，也可以访问到`D`，但`D`不一定能直接访问到`B`/`E`，因为`B`/`E`在局域网

这样，就可以在`D`和`E`上均搭建一个服务

`E`上的服务启动后，立刻主动与`D`上的服务建立起一个tcp连接，因为是由`E`发起连接到`D`，因此`D`不能直接访问到`E`也没关系

`D`上的服务在与E上的服务建立连接后，等待`A`的请求，然后将请求数据通过与`E`的连接转发给`E`，最后再由`E`上的服务将数据转发给最终目标服务`B`

目标服务的响应再由`E`传给`D`，`D`再传回给`A`

这样，看起来`A`访问的是`D`，但实际上访问的是`B`

`B`虽然在局域网内，但`A`仍可以经由公网访问到`B`，因此一般这种方式被称为内网穿透

![intranet-proxy](https://user-images.githubusercontent.com/17873791/172583743-2176d1a7-108a-45ac-99cc-09f5686f9a7a.jpg)


* ① 转发服务发起请求与入口服务建立起tcp长链
* ② 请求者与入口服务建立tcp连接，并发送请求数据
* ③ 入口服务通过①建立的tcp长链，将请求者的请求数据，转发给转发服务
* ④ 转发服务收到数据后，与目标服务建立tcp连接，并转发请求数据给目标服务
* ⑤ 目标服务通过④建立的tcp链接，将响应数据传输给转发服务
* ⑥ 转发服务将响应数据通过①建立的tcp长链，传输给入口服务
* ⑦ 入口服务收到响应数据后，通过②建立的tcp长链，传输给请求者
* 最终完成A与目标服务B之间的数据交互

整个网络情况中
* a. A无法连接到B，B也无法连接到A：各自在各自的局域网
* b. D无法直连到E，但E可以连接到D：D在公网，而E在内网

配置代码例
```
#公网入口服务D
intranet:
- type: entry
  port: 3306    #接收请求者A请求的服务端口号
  relay: 82   #接收转发服务E建立连接的服务端口号

#目标服务机器或与其在同一局域网的转发服务E
intranet:
- type: relay
  entry: D:82     #入口服务D的地址，E服务启动时会与其建立长久的tcp连接
  target: B:3306  #最终目标服务B的地址
```

> tcp协议，发起请求者必须能连上提供服务者，而一旦建立起连接后，tcp就可以完成双向传输。内网穿透本质上就是利用该特性实现的
